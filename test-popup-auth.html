<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popup Authentication Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            font-weight: 600;
            transition: all 0.2s;
        }
        button:hover {
            background: #3367d6;
        }
        .bookmarklet {
            display: inline-block;
            background: #48bb78;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin: 10px;
            transition: all 0.2s;
        }
        .bookmarklet:hover {
            background: #38a169;
        }
        .warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fbbf24;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }
        pre {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Popup Authentication Test</h1>
        
        <div class="warning">
            <strong>Testing Purpose:</strong> This page tests the popup authentication system that allows the bookmarklet to work from any website, not just our authorized domain.
        </div>

        <div class="test-section">
            <h2>Test 1: Direct Popup Test</h2>
            <p>Test the authentication popup directly:</p>
            <button onclick="testAuthPopup()">Open Auth Popup (Localhost)</button>
            <button onclick="testAuthPopupProduction()">Open Auth Popup (Production)</button>
        </div>

        <div class="test-section">
            <h2>Test 2: Bookmarklet with Popup Auth</h2>
            <p>Test the bookmarklet that uses popup authentication:</p>
            <a href="javascript:(function(){var s=document.createElement('script');s.src='http://localhost:8002/bookmarklet-main-popup-test.js';document.head.appendChild(s);})();" class="bookmarklet">Test Bookmarklet (Localhost)</a>
        </div>

        <div class="test-section">
            <h2>Test 3: Cross-Domain Test</h2>
            <p>Test from a different domain (simulating real usage):</p>
            <div class="warning">
                <strong>Instructions:</strong>
                <ol>
                    <li>Drag the bookmarklet above to your bookmarks bar</li>
                    <li>Navigate to any other website (e.g., google.com, github.com)</li>
                    <li>Click the bookmarklet from your bookmarks bar</li>
                    <li>It should open a popup for authentication instead of failing</li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <h2>Expected Behavior</h2>
            <div class="success">
                <strong>‚úÖ Success Criteria:</strong>
                <ul>
                    <li>Bookmarklet works from any website (not just vatsal-ships.github.io)</li>
                    <li>Opens popup window for authentication</li>
                    <li>Popup authenticates from authorized domain</li>
                    <li>Token is passed back to main bookmarklet</li>
                    <li>No "redirect_uri_mismatch" or "origin not authorized" errors</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h2>Technical Details</h2>
            <pre>
How it works:
1. User clicks bookmarklet on any website (e.g., shopify.zendesk.com)
2. Bookmarklet opens popup to: https://vatsal-ships.github.io/auth-popup.html
3. Popup authenticates using Google OAuth (from authorized domain)
4. Popup sends token back to parent window via postMessage
5. Main bookmarklet receives token and can make API calls
6. No domain restrictions because auth happens in authorized popup
            </pre>
        </div>

        <div id="test-results" style="margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 8px; display: none;">
            <h3>Test Results:</h3>
            <div id="results-content"></div>
        </div>
    </div>

    <script>
        function testAuthPopup() {
            const popup = window.open('http://localhost:8002/auth-popup-localhost.html', 'auth-popup', 'width=500,height=600,scrollbars=yes,resizable=yes');
            
            const messageHandler = (event) => {
                if (event.origin !== 'http://localhost:8002') {
                    return;
                }
                
                if (event.data.type === 'auth-success') {
                    showTestResult('‚úÖ Localhost popup test successful! Token received: ' + event.data.token);
                    window.removeEventListener('message', messageHandler);
                }
            };
            
            window.addEventListener('message', messageHandler);
        }

        function testAuthPopupProduction() {
            const popup = window.open('https://vatsal-ships.github.io/impactDoc-bookmarklet/auth-popup.html', 'auth-popup', 'width=500,height=600,scrollbars=yes,resizable=yes');
            
            const messageHandler = (event) => {
                if (event.origin !== 'https://vatsal-ships.github.io') {
                    return;
                }
                
                if (event.data.type === 'auth-success') {
                    showTestResult('‚úÖ Production popup test successful! Token received: ' + event.data.token);
                    window.removeEventListener('message', messageHandler);
                }
            };
            
            window.addEventListener('message', messageHandler);
        }

        function showTestResult(message) {
            const resultsDiv = document.getElementById('test-results');
            const contentDiv = document.getElementById('results-content');
            
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML += '<div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">' + message + '</div>';
        }

        // Listen for any auth messages for testing
        window.addEventListener('message', (event) => {
            console.log('Received message:', event.data);
        });
    </script>
</body>
</html> 