window.initImpactDoc=function(){if(document.getElementById('browser-page-impact-dialog'))return;if(!ensureBasicDOM()){console.error('ImpactDoc: Cannot initialize on this page');return}const CLIENT_ID='267135613225-0q6672a1dl8f3bd1dg123ea2lf1b2er9.apps.googleusercontent.com',API_KEY='AIzaSyAWg7PkUqRiBoQOOYlVwQJG6PKuxQqN5cA',DISCOVERY_DOC='https://docs.googleapis.com/$discovery/rest?version=v1',SCOPES='https://www.googleapis.com/auth/documents';let gapiInited=!1,isAuthenticated=!1,masterDocId;function ensureBasicDOM(){try{if(location.protocol==='chrome:'||location.protocol==='chrome-extension:'||location.protocol==='moz-extension:'||location.hostname==='newtab'){console.error('Bookmarklet blocked on this page type');alert('ImpactDoc cannot run on browser special pages.\nPlease navigate to a website (like google.com) first, then try again.');return!1}if(!document.documentElement){console.error('No document element');return!1}if(!document.head){const head=document.createElement('head');document.documentElement.appendChild(head)}if(!document.body){const body=document.createElement('body');document.documentElement.appendChild(body)}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>{if(typeof window.initImpactDoc==='function'){window.initImpactDoc()}},100)});return!1}return!0}catch(e){console.error('DOM setup failed:',e);if(location.protocol==='about:'||location.href==='about:blank'){alert('ImpactDoc cannot run on empty pages.\nPlease navigate to a website first, then try again.')}return!1}}function simpleEncrypt(text){return btoa(text.split('').map(char=>String.fromCharCode(char.charCodeAt(0)^123)).join(''))}function simpleDecrypt(encrypted){try{return atob(encrypted).split('').map(char=>String.fromCharCode(char.charCodeAt(0)^123)).join('')}catch(e){return null}}function isLocalDevelopment(){return window.location.protocol==='file:'||window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1'||window.location.hostname.endsWith('.local')}const STORAGE_BRIDGE_URL='https://vatsal-ships.github.io/impactDoc-bookmarklet/storage-bridge.html';let storageBridge=null,pendingStorageRequests=new Map,storageRequestId=0;function initStorageBridge(){if(storageBridge)return Promise.resolve();return new Promise((resolve,reject)=>{storageBridge=document.createElement('iframe');storageBridge.style.display='none';storageBridge.src=STORAGE_BRIDGE_URL;const messageHandler=event=>{if(event.origin!=='https://vatsal-ships.github.io')return;if(event.data.type==='storage-bridge-ready'){window.removeEventListener('message',messageHandler);resolve()}else if(event.data.type==='storage-response'){const request=pendingStorageRequests.get(event.data.requestId);if(request){pendingStorageRequests.delete(event.data.requestId);event.data.success?request.resolve(event.data.value):request.reject(new Error(event.data.error))}}};window.addEventListener('message',messageHandler);storageBridge.onerror=()=>{window.removeEventListener('message',messageHandler);reject(new Error('Failed to load storage bridge'))};document.body.appendChild(storageBridge);setTimeout(()=>{if(pendingStorageRequests.size===0)return;window.removeEventListener('message',messageHandler);reject(new Error('Storage bridge timeout'))},2000)})}function sendStorageMessage(action,key,value=null){return new Promise((resolve,reject)=>{const requestId=++storageRequestId;pendingStorageRequests.set(requestId,{resolve,reject});storageBridge.contentWindow.postMessage({type:'storage-request',requestId,action,key,value},'https://vatsal-ships.github.io');setTimeout(()=>{if(pendingStorageRequests.has(requestId)){pendingStorageRequests.delete(requestId);reject(new Error('Storage request timeout'))}},5000)})}async function getStoredValue(key){try{const localValue=localStorage.getItem(key);if(localValue)return localValue;if(isLocalDevelopment())return null;const timeoutPromise=new Promise((_,reject)=>setTimeout(()=>reject(new Error('Bridge timeout')),3000));const bridgePromise=(async()=>{await initStorageBridge();return await sendStorageMessage('get',key)})();return await Promise.race([bridgePromise,timeoutPromise])}catch(e){console.warn('Storage bridge failed on this site, using localStorage only');return null}}async function setStoredValue(key,value){try{localStorage.setItem(key,value);if(isLocalDevelopment())return!0;(async()=>{try{await initStorageBridge();await sendStorageMessage('set',key,value)}catch(e){}})();return!0}catch(e){return!1}}async function removeStoredValue(key){try{localStorage.removeItem(key);if(isLocalDevelopment())return!0;(async()=>{try{await initStorageBridge();await sendStorageMessage('remove',key)}catch(e){}})();return!0}catch(e){return!1}}async function getStoredToken(){try{const tokenString=await getStoredValue('browserPageImpact_token');if(!tokenString)return null;const decrypted=simpleDecrypt(tokenString);if(!decrypted)return null;const parsed=JSON.parse(decrypted),now=Date.now();if(parsed.permanentMode){return parsed}if(parsed.expiresAt&&now>=(parsed.expiresAt-300000)){await removeStoredValue('browserPageImpact_token');return null}return parsed}catch(e){return null}}async function storeToken(token,expiresIn,permanentMode=false){try{const tokenData=permanentMode?{access_token:token,permanentMode:true}:{access_token:token,expiresAt:Date.now()+(expiresIn*1000)},encrypted=simpleEncrypt(JSON.stringify(tokenData));localStorage.setItem('browserPageImpact_token',encrypted);try{await setStoredValue('browserPageImpact_token',encrypted)}catch(e){}return!0}catch(e){return!1}}async function initializeMasterDocId(){try{const localDocId=localStorage.getItem('browserPageImpact_docId');if(localDocId){masterDocId=localDocId;return}const docId=await getStoredValue('browserPageImpact_docId');if(docId){masterDocId=docId;localStorage.setItem('browserPageImpact_docId',docId)}}catch(e){}}async function handleTokenExpiration(){await removeStoredValue('browserPageImpact_token');gapi.client.setToken('');isAuthenticated=!1;contentSection.style.display='none';setupSection.style.display='none';authSection.style.display='block';showStatus('Session expired. Please sign in again.',!0)}const months=['January','February','March','April','May','June','July','August','September','October','November','December'];const dialogHTML=`<div id="browser-page-impact-dialog" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:8px;padding:20px;width:380px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:10000;font-family:-apple-system,BlinkMacSystemFont,sans-serif;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><h3 style="margin:0;font-size:18px;color:#333;">ImpactDoc</h3><button id="close-dialog" style="background:none;border:none;font-size:20px;cursor:pointer;color:#666;">×</button></div><div id="loading-section" style="display:block;text-align:center;"><p style="color:#4a5568;margin-bottom:20px;font-size:16px;">Loading...</p></div><div id="auth-section" style="display:none;text-align:center;"><p style="color:#4a5568;margin-bottom:20px;font-size:16px;">Connect your Google account to access your private document</p><div style="margin-bottom:16px;text-align:left;"><label style="display:flex;align-items:center;font-size:14px;color:#4a5568;"><input id="permanent-token-checkbox" type="checkbox" style="margin-right:8px;"> Keep me signed in permanently (until browser data is cleared)</label><p style="margin:8px 0 0 0;font-size:12px;color:#e53e3e;">⚠️ Security Warning: Permanent tokens persist even after password changes. Only use on trusted devices.</p></div><button id="auth-button" style="background:#4285f4;color:white;border:none;padding:14px 28px;border-radius:12px;cursor:pointer;font-size:16px;width:100%;margin-bottom:16px;font-weight:600;">Sign in with Google</button></div><div id="setup-section" style="display:none;"><p style="color:#4a5568;margin-bottom:16px;font-size:16px;">Enter your Google Doc ID:</p><input id="doc-id-input" type="text" placeholder="Paste your Google Doc ID here" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;margin-bottom:16px;box-sizing:border-box;"><button id="connect-doc-button" style="background:#4285f4;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:16px;width:100%;font-weight:600;">Connect Document</button></div><div id="content-section" style="display:none;"><div style="margin-bottom:16px;"><label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">Month:</label><select id="month-select" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;"></select></div><div style="margin-bottom:16px;"><label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">Entry Title:</label><input id="entry-title" type="text" placeholder="Enter entry title" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;box-sizing:border-box;"></div><div style="margin-bottom:16px;"><label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">Content:</label><textarea id="content-text" placeholder="Enter your content here" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;resize:vertical;min-height:100px;box-sizing:border-box;"></textarea></div><div style="display:flex;gap:8px;margin-bottom:16px;"><button id="add-entry-button" style="background:#4285f4;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:16px;flex:1;font-weight:600;">Add Entry</button><button id="view-doc-button" style="background:#48bb78;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:16px;flex:1;font-weight:600;">View Doc</button></div><div style="display:flex;gap:8px;"><button id="change-doc-button" style="background:#e53e3e;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;flex:1;">Change Doc</button><button id="sign-out-button" style="background:#718096;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;flex:1;">Sign Out</button></div></div><div id="status-section" style="margin-top:16px;padding:12px;background:#f8fafc;border-radius:8px;text-align:center;"><p id="status-text" style="margin:0;font-size:14px;color:#4a5568;"></p></div></div>`;document.body.insertAdjacentHTML('beforeend',dialogHTML);const dialog=document.getElementById('browser-page-impact-dialog'),closeButton=document.getElementById('close-dialog'),authSection=document.getElementById('auth-section'),authButton=document.getElementById('auth-button'),setupSection=document.getElementById('setup-section'),connectDocButton=document.getElementById('connect-doc-button'),contentSection=document.getElementById('content-section'),addEntryButton=document.getElementById('add-entry-button'),viewDocButton=document.getElementById('view-doc-button'),changeDocButton=document.getElementById('change-doc-button'),signOutButton=document.getElementById('sign-out-button'),monthSelect=document.getElementById('month-select'),statusText=document.getElementById('status-text');const currentMonth=new Date().getMonth();for(let i=0;i<months.length;i++){const option=document.createElement('option');option.value=i;option.textContent=months[i];if(i===currentMonth)option.selected=!0;monthSelect.appendChild(option)}function closeDialog(){dialog.remove()}function showStatus(message,isError=!1){statusText.textContent=message;statusText.style.color=isError?'#e53e3e':'#4a5568'}async function initializeFastPath(){const forceShowAuth=setTimeout(()=>{try{const loadingSection=document.getElementById('loading-section');if(loadingSection)loadingSection.style.display='none';authSection.style.display='block';authButton.disabled=!1;showStatus('Click to authenticate with Google')}catch(e){}},2000);const localToken=localStorage.getItem('browserPageImpact_token'),localDocId=localStorage.getItem('browserPageImpact_docId');if(localToken){try{const decrypted=simpleDecrypt(localToken);if(decrypted){const parsed=JSON.parse(decrypted),now=Date.now();if(!parsed.expiresAt||now<(parsed.expiresAt-300000)){if(localDocId){clearTimeout(forceShowAuth);masterDocId=localDocId;isAuthenticated=!0;const loadingSection1=document.getElementById('loading-section');if(loadingSection1)loadingSection1.style.display='none';authSection.style.display='none';contentSection.style.display='block';showStatus('Ready to add entries!');loadGoogleAPIsWithToken(parsed.access_token);return}else{clearTimeout(forceShowAuth);isAuthenticated=!0;const loadingSection2=document.getElementById('loading-section');if(loadingSection2)loadingSection2.style.display='none';authSection.style.display='none';setupSection.style.display='block';showStatus('Please enter your Google Doc ID');loadGoogleAPIsWithToken(parsed.access_token);return}}else{localStorage.removeItem('browserPageImpact_token')}}}catch(e){localStorage.removeItem('browserPageImpact_token')}}try{showStatus('Checking authentication...');const timeoutPromise=new Promise((_,reject)=>setTimeout(()=>reject(new Error('Storage bridge timeout')),2500));const bridgePromise=(async()=>{await initializeMasterDocId();return await getStoredToken()})();const storedToken=await Promise.race([bridgePromise,timeoutPromise]);if(storedToken&&masterDocId){clearTimeout(forceShowAuth);isAuthenticated=!0;const loadingSection3=document.getElementById('loading-section');if(loadingSection3)loadingSection3.style.display='none';authSection.style.display='none';contentSection.style.display='block';showStatus('Ready to add entries!');loadGoogleAPIsWithToken(storedToken.access_token)}else if(storedToken){clearTimeout(forceShowAuth);isAuthenticated=!0;const loadingSection4=document.getElementById('loading-section');if(loadingSection4)loadingSection4.style.display='none';authSection.style.display='none';setupSection.style.display='block';showStatus('Please enter your Google Doc ID');loadGoogleAPIsWithToken(storedToken.access_token)}else{clearTimeout(forceShowAuth);const loadingSection5=document.getElementById('loading-section');if(loadingSection5)loadingSection5.style.display='none';authSection.style.display='block';authButton.disabled=!1;showStatus('Click to authenticate with Google')}}catch(error){console.warn('Cross-site storage blocked on this website, authentication may be required each time');clearTimeout(forceShowAuth);const loadingSection6=document.getElementById('loading-section');if(loadingSection6)loadingSection6.style.display='none';authSection.style.display='block';authButton.disabled=!1;showStatus('Click to authenticate with Google')}}function loadGoogleAPIsBackground(){if(gapiInited)return;const gapiScript=document.createElement('script');gapiScript.src='https://apis.google.com/js/api.js';gapiScript.onload=()=>{gapi.load('client',()=>{gapi.client.init({apiKey:API_KEY,discoveryDocs:[DISCOVERY_DOC]}).then(()=>{gapiInited=!0;const storedToken=localStorage.getItem('browserPageImpact_token');if(storedToken){try{const decrypted=simpleDecrypt(storedToken);if(decrypted){const parsed=JSON.parse(decrypted);gapi.client.setToken({access_token:parsed.access_token});isAuthenticated=!0}}catch(e){}}}).catch(error=>{})})};document.head.appendChild(gapiScript)}function loadGoogleAPIs(){if(gapiInited)return Promise.resolve();return new Promise((resolve,reject)=>{showStatus('Loading Google APIs...');const gapiScript=document.createElement('script');gapiScript.src='https://apis.google.com/js/api.js';gapiScript.onload=()=>{gapi.load('client',()=>{gapi.client.init({apiKey:API_KEY,discoveryDocs:[DISCOVERY_DOC]}).then(()=>{gapiInited=!0;resolve()}).catch(reject)})};gapiScript.onerror=()=>{reject(new Error('Failed to load Google APIs'))};document.head.appendChild(gapiScript)})}function loadGoogleAPIsWithToken(accessToken){if(gapiInited){gapi.client.setToken({access_token:accessToken});return}const gapiScript=document.createElement('script');gapiScript.src='https://apis.google.com/js/api.js';gapiScript.onload=()=>{gapi.load('client',()=>{gapi.client.init({apiKey:API_KEY,discoveryDocs:[DISCOVERY_DOC]}).then(()=>{gapiInited=!0;gapi.client.setToken({access_token:accessToken});console.log('✅ Google APIs loaded with stored token')}).catch(error=>{console.warn('Google API init failed:',error)})})};document.head.appendChild(gapiScript)}async function handleAuthClick(){showStatus('Opening authentication popup...');try{await loadGoogleAPIs()}catch(error){showStatus('Failed to load Google APIs: '+error.message,!0);return}const authUrl='https://vatsal-ships.github.io/impactDoc-bookmarklet/auth-popup.html',popup=window.open(authUrl,'auth-popup','width=500,height=600,scrollbars=yes,resizable=yes');let authCompleted=!1;const messageHandler=async event=>{if(event.origin!=='https://vatsal-ships.github.io')return;if(event.data.type==='auth-success'){authCompleted=!0;clearInterval(checkClosed);showStatus('Storing authentication...');const permanentMode=document.getElementById('permanent-token-checkbox').checked;await storeToken(event.data.token,event.data.expiresIn,permanentMode);gapi.client.setToken({access_token:event.data.token,expires_in:event.data.expiresIn});isAuthenticated=!0;let docId=localStorage.getItem('browserPageImpact_docId');if(!docId){try{docId=await getStoredValue('browserPageImpact_docId');if(docId)localStorage.setItem('browserPageImpact_docId',docId)}catch(e){}}authSection.style.display='none';if(docId){masterDocId=docId;contentSection.style.display='block';showStatus('Successfully authenticated! Ready to add entries.')}else{setupSection.style.display='block';showStatus('Successfully authenticated! Please enter your Google Doc ID.')}window.removeEventListener('message',messageHandler);if(popup&&!popup.closed)popup.close()}};window.addEventListener('message',messageHandler);const checkClosed=setInterval(()=>{if(popup.closed&&!authCompleted){clearInterval(checkClosed);window.removeEventListener('message',messageHandler);showStatus('Authentication cancelled')}},1000)}async function connectDocument(){const docId=document.getElementById('doc-id-input').value.trim();if(!docId){showStatus('Please enter a Google Doc ID',!0);return}connectDocButton.disabled=!0;connectDocButton.textContent='Connecting...';showStatus('Verifying document access...');try{if(!gapiInited){await loadGoogleAPIs();const storedToken=await getStoredToken();if(storedToken){gapi.client.setToken({access_token:storedToken.access_token});isAuthenticated=!0}}await gapi.client.docs.documents.get({documentId:docId});masterDocId=docId;await setStoredValue('browserPageImpact_docId',docId);setupSection.style.display='none';contentSection.style.display='block';showStatus('Document connected successfully!')}catch(error){if(error.status===401||error.status===403){handleTokenExpiration();return}showStatus('Cannot access document. Please check the ID and make sure you have edit access.',!0)}finally{connectDocButton.disabled=!1;connectDocButton.textContent='Connect Document'}}async function findOrCreateMonthSection(monthIndex){const currentYear=new Date().getFullYear(),selectedMonth=months[monthIndex],monthHeader=`${selectedMonth} ${currentYear}`;try{const doc=await gapi.client.docs.documents.get({documentId:masterDocId}),content=doc.result.body.content;let insertIndex=-1,monthExists=!1;for(let i=0;i<content.length;i++){if(content[i].paragraph&&content[i].paragraph.elements){const text=content[i].paragraph.elements[0].textRun?.content||'';if(text.includes(monthHeader)){monthExists=!0;for(let j=i+1;j<content.length;j++){if(content[j].paragraph&&content[j].paragraph.elements){const nextText=content[j].paragraph.elements[0].textRun?.content||'';if(months.some(month=>nextText.includes(`${month} ${currentYear}`)&&!nextText.includes(monthHeader))){insertIndex=content[j].startIndex;break}}}if(insertIndex===-1)insertIndex=content[content.length-1].endIndex-1;break}}}if(!monthExists){insertIndex=content[content.length-1].endIndex-1;const monthSection=`\n${monthHeader}\n\n`;await gapi.client.docs.documents.batchUpdate({documentId:masterDocId,resource:{requests:[{insertText:{location:{index:insertIndex},text:monthSection}},{updateTextStyle:{range:{startIndex:insertIndex+2,endIndex:insertIndex+2+monthHeader.length},textStyle:{bold:!0,fontSize:{magnitude:14,unit:'PT'}},fields:'bold,fontSize'}}]}});insertIndex=insertIndex+monthSection.length}return insertIndex}catch(error){if(error.status===401||error.status===403){handleTokenExpiration();throw new Error('Authentication expired')}throw error}}async function addEntry(){const monthIndex=parseInt(document.getElementById('month-select').value),entryTitle=document.getElementById('entry-title').value.trim(),content=document.getElementById('content-text').value.trim();if(!entryTitle){showStatus('Please enter an entry title',!0);return}if(!content){showStatus('Please enter some content',!0);return}addEntryButton.disabled=!0;addEntryButton.textContent='Adding...';showStatus('Adding entry to document...');try{if(!gapiInited){await loadGoogleAPIs();const storedToken=await getStoredToken();if(storedToken){gapi.client.setToken({access_token:storedToken.access_token});isAuthenticated=!0}}const insertIndex=await findOrCreateMonthSection(monthIndex),timestamp=new Date().toLocaleString(),entry=`\n${timestamp}\n${entryTitle}\n${content}\n\n`;await gapi.client.docs.documents.batchUpdate({documentId:masterDocId,resource:{requests:[{insertText:{location:{index:insertIndex},text:entry}},{updateTextStyle:{range:{startIndex:insertIndex,endIndex:insertIndex+entry.length},textStyle:{bold:!1,italic:!1,underline:!1,strikethrough:!1,fontSize:{magnitude:11,unit:'PT'},foregroundColor:{color:{rgbColor:{red:0,green:0,blue:0}}},weightedFontFamily:{fontFamily:'Arial'},backgroundColor:{color:{rgbColor:{red:1,green:1,blue:1}}}},fields:'bold,italic,underline,strikethrough,fontSize,foregroundColor,weightedFontFamily,backgroundColor'}}]}});showStatus('Entry added successfully!');document.getElementById('entry-title').value='';document.getElementById('content-text').value=''}catch(error){if(error.status===401||error.status===403){handleTokenExpiration();return}showStatus('Failed to add entry: '+error.message,!0)}finally{addEntryButton.disabled=!1;addEntryButton.textContent='Add Entry'}}function viewDocument(){if(masterDocId)window.open(`https://docs.google.com/document/d/${masterDocId}/edit`,'_blank')}async function changeDocument(){masterDocId=null;await removeStoredValue('browserPageImpact_docId');contentSection.style.display='none';setupSection.style.display='block';document.getElementById('doc-id-input').value='';showStatus('Ready to connect to a different document')}async function signOut(){const token=gapi.client.getToken();if(token!==null){gapi.client.setToken('')}await removeStoredValue('browserPageImpact_token');isAuthenticated=!1;authSection.style.display='block';setupSection.style.display='none';contentSection.style.display='none';showStatus('Signed out successfully')}try{closeButton.addEventListener('click',closeDialog);authButton.addEventListener('click',handleAuthClick);connectDocButton.addEventListener('click',connectDocument);addEntryButton.addEventListener('click',addEntry);viewDocButton.addEventListener('click',viewDocument);changeDocButton.addEventListener('click',changeDocument);signOutButton.addEventListener('click',signOut);dialog.addEventListener('click',e=>{if(e.target===dialog)closeDialog()})}catch(error){alert('ImpactDoc: Failed to initialize event handlers. Please refresh and try again.');return}setTimeout(()=>{try{initializeFastPath()}catch(error){try{const loadingSection7=document.getElementById('loading-section');if(loadingSection7)loadingSection7.style.display='none';authSection.style.display='block';authButton.disabled=!1;showStatus('Click to authenticate with Google')}catch(e){alert('ImpactDoc: Failed to initialize. Please refresh and try again.')}}},10)};console.log('✅ ImpactDoc minified script loaded successfully'); 