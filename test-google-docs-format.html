<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Docs API Formatting Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background: #3367d6;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        .info {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1565c0;
        }
        .highlight {
            background: #fff3e0;
            border-color: #ff9800;
            color: #e65100;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Google Docs API Formatting Test</h1>
        <p>This test verifies that the Google Docs API formatting request is properly structured to prevent bold text entries.</p>
        
        <div class="test-section">
            <h3>Test Configuration</h3>
            <p>This test simulates the exact API call structure used in the bookmarklet.</p>
            <button onclick="testBatchUpdateRequest()">Test batchUpdate Request Structure</button>
            <button onclick="testFormattingFields()">Test Formatting Fields</button>
            <button onclick="testCompleteFlow()">Test Complete Entry Flow</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function testBatchUpdateRequest() {
            const resultsDiv = document.getElementById('results');
            
            // Simulate the exact request structure
            const insertIndex = 150; // Example index
            const timestamp = new Date().toLocaleString();
            const entryTitle = "Test Entry Title";
            const content = "This is test content for the entry.";
            const entry = `\n${timestamp}\n${entryTitle}\n${content}\n\n`;
            
            const batchUpdateRequest = {
                documentId: "DOCUMENT_ID_PLACEHOLDER",
                resource: {
                    requests: [
                        {
                            insertText: {
                                location: { index: insertIndex },
                                text: entry
                            }
                        },
                        {
                            updateTextStyle: {
                                range: {
                                    startIndex: insertIndex,
                                    endIndex: insertIndex + entry.length
                                },
                                textStyle: {
                                    bold: false,
                                    italic: false,
                                    underline: false,
                                    strikethrough: false,
                                    fontSize: { magnitude: 11, unit: 'PT' },
                                    foregroundColor: {
                                        color: {
                                            rgbColor: {
                                                red: 0.0,
                                                green: 0.0,
                                                blue: 0.0
                                            }
                                        }
                                    },
                                    weightedFontFamily: {
                                        fontFamily: 'Arial'
                                    },
                                    backgroundColor: {
                                        color: {
                                            rgbColor: {
                                                red: 1.0,
                                                green: 1.0,
                                                blue: 1.0
                                            }
                                        }
                                    }
                                },
                                fields: 'bold,italic,underline,strikethrough,fontSize,foregroundColor,weightedFontFamily,backgroundColor'
                            }
                        }
                    ]
                }
            };
            
            resultsDiv.innerHTML = `
                <div class="result">
                    <h4>‚úÖ Google Docs batchUpdate Request Structure</h4>
                    <strong>Entry Text (${entry.length} chars):</strong>
                    "${entry}"
                    
                    <strong>Range:</strong>
                    Start: ${insertIndex}, End: ${insertIndex + entry.length}
                    
                    <strong>Text Style Properties:</strong>
                    - bold: false (explicitly disabled)
                    - italic: false (explicitly disabled) 
                    - underline: false (explicitly disabled)
                    - strikethrough: false (explicitly disabled)
                    - fontSize: 11pt
                    - foregroundColor: black (RGB: 0,0,0)
                    - backgroundColor: white (RGB: 1,1,1)
                    - fontFamily: Arial
                    
                    <strong>Fields Updated:</strong>
                    ${batchUpdateRequest.resource.requests[1].updateTextStyle.fields}
                    
                    <strong>Complete Request JSON:</strong>
                    ${JSON.stringify(batchUpdateRequest, null, 2)}
                </div>
            `;
        }
        
        function testFormattingFields() {
            const resultsDiv = document.getElementById('results');
            
            const formattingAnalysis = {
                "bold: false": "‚úÖ Explicitly prevents bold text",
                "italic: false": "‚úÖ Explicitly prevents italic text", 
                "underline: false": "‚úÖ Explicitly prevents underlined text",
                "strikethrough: false": "‚úÖ Explicitly prevents strikethrough text",
                "fontSize: 11pt": "‚úÖ Sets standard document font size",
                "foregroundColor: black": "‚úÖ Sets standard text color",
                "backgroundColor: white": "‚úÖ Sets standard background color",
                "fontFamily: Arial": "‚úÖ Sets consistent font family",
                "fields parameter": "‚úÖ Tells API which properties to update"
            };
            
            const potentialIssues = [
                "‚úÖ Single batch update prevents race conditions",
                "‚úÖ Range covers entire inserted text",
                "‚úÖ All formatting properties explicitly set",
                "‚úÖ Fields parameter includes all modified properties",
                "‚úÖ Text insertion happens before formatting",
                "‚ö†Ô∏è  Formatting relies on proper range calculation"
            ];
            
            resultsDiv.innerHTML = `
                <div class="result">
                    <h4>üîç Formatting Fields Analysis</h4>
                    
                    <strong>Formatting Properties:</strong>
                    ${Object.entries(formattingAnalysis).map(([key, value]) => 
                        `${key}: ${value}`
                    ).join('\n')}
                    
                    <strong>Potential Issues Check:</strong>
                    ${potentialIssues.join('\n')}
                    
                    <strong>Why This Should Work:</strong>
                    1. We explicitly set bold: false to override any inherited bold formatting
                    2. We use a single batch update to avoid timing issues
                    3. We format the entire inserted text range
                    4. We set all major text style properties to standard values
                    5. The fields parameter tells Google Docs exactly what to update
                </div>
            `;
        }
        
        function testCompleteFlow() {
            const resultsDiv = document.getElementById('results');
            
            // Simulate the complete flow
            const steps = [
                "1. Find or create month section",
                "2. Generate timestamp and entry text", 
                "3. Calculate insertion index",
                "4. Create batch update request with:",
                "   a. insertText request",
                "   b. updateTextStyle request",
                "5. Execute single batchUpdate call",
                "6. Google Docs processes both requests atomically"
            ];
            
            const debugInfo = {
                "Entry Format": "\\n{timestamp}\\n{title}\\n{content}\\n\\n",
                "Text Style Override": "Explicitly sets all formatting to normal",
                "Range Calculation": "startIndex to startIndex + entry.length",
                "Batch Processing": "Both insert and format in single API call",
                "Field Mask": "Tells API exactly which properties to update"
            };
            
            resultsDiv.innerHTML = `
                <div class="result">
                    <h4>üîÑ Complete Entry Flow</h4>
                    
                    <strong>Process Steps:</strong>
                    ${steps.join('\n')}
                    
                    <strong>Key Implementation Details:</strong>
                    ${Object.entries(debugInfo).map(([key, value]) => 
                        `${key}: ${value}`
                    ).join('\n')}
                    
                    <strong>Expected Result:</strong>
                    ‚úÖ Text inserted in normal (non-bold) formatting
                    ‚úÖ Consistent appearance across all entries  
                    ‚úÖ No inheritance of document's current formatting
                    ‚úÖ Reliable formatting regardless of cursor position
                    
                    <strong>If Still Bold After This Fix:</strong>
                    - Check if document has custom styles affecting the range
                    - Verify the range calculation is correct
                    - Ensure no other formatting is being applied after this
                    - Check if month headers are affecting paragraph inheritance
                </div>
            `;
        }
        
        // Auto-run basic test on page load
        window.onload = function() {
            document.getElementById('results').innerHTML = `
                <div class="result info">
                    <h4>üìã Google Docs API Formatting Test Ready</h4>
                    <p>This test verifies the bookmarklet's text formatting implementation.</p>
                    
                    <p><strong>Key Improvements Made:</strong></p>
                    <ul>
                        <li>‚úÖ Added explicit bold: false to prevent bold inheritance</li>
                        <li>‚úÖ Added strikethrough: false for completeness</li>
                        <li>‚úÖ Added backgroundColor: white to ensure clean background</li>
                        <li>‚úÖ Updated fields parameter to include all properties</li>
                        <li>‚úÖ Single batch update for atomic operation</li>
                    </ul>
                    
                    <p>Click the buttons above to run specific tests.</p>
                </div>
            `;
        };
    </script>
</body>
</html> 